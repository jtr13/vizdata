--- 
title: "Dataset guide"
author: "Joyce Robbins"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---

```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE,
                      results = 'asis')
```

```{r}
library(magrittr)
get_data <- function(packagename) {
    datafile <- paste0("data/", packagename)
    metafile <- paste0("description/", packagename)
    
    # always update data and metadata together
    if (file.exists(datafile) & file.exists(metafile)) {
      pkgdata <- readRDS(datafile)
    } else {
      browser()
      if (packagename == "datasets") {
        metadata <- list(Description = "Base R datasets")
        pkgdata <- datacat::data_xray("datasets")
        } else {
        metadata <- pkgsearch::cran_package(packagename)
        pkgdata <- datacat::data_xray(packagename, link = TRUE)
        }
      saveRDS(metadata, file = metafile)
      saveRDS(pkgdata, file = datafile)
      }
    pkgdata
    }

show_data <- function(data,
                      targets = c(0, 4, 9:11),
                      description = TRUE) {
  if(description) cat(readRDS(paste0("description/",
                                     data$package[1]))$Description)   
  DT::datatable(data,
                escape = FALSE,
                rownames = FALSE,
                filter = 'top',
                options = list(columnDefs = list(list(targets = targets, 
                                                      visible = FALSE)),
                               buttons = c('colvis'),
                               dom = 'lBrtip'),
                extensions = 'Buttons') 
}


show <- function(packagename) {
#  cat(packageDescription(packagename)$Description)
  get_data(packagename) %>% show_data()
}

# To do: add package version to datacat, update targets for colvis
```

```{r}
# Create second chapter
packages <- sort(readLines("packages.txt"))
  
add_package <- function(package) c(paste0("## **", package, "**"), "```{r}",
                                   paste0("show('", package, "')"),
                                   "```", "")

writeLines(c("# R packages (listed separately)", "",
             "<!-- Generated by index.Rmd, do not edit. -->", "",
             unlist(lapply(packages, add_package))), "02-rpack.Rmd")
```


# Introduction

## Guide to tables

The tables in the following chapters provide detailed information about datasets in R packages. The complete list of output columns is as follows. Columns not initially visible can be viewed by clicking the `Column Visibility` button.


```{r}
# https://haozhu233.github.io/kableExtra/bookdown/use-bootstrap-tables-in-gitbooks-epub.html#gitbook
options(kableExtra.html.bsTable = T)

# *** Keep output columns in datacat's README.md up to date so this is accurate! ***

`Output columns` <- readLines("https://raw.githubusercontent.com/jtr13/datacat/master/README.md") %>% 
  stringr::str_extract("^\\*.*$") %>% 
  na.omit() %>% 
  stringr::str_remove_all("\\* ")
  
tibble::tibble(`Output columns`) %>% knitr::kable(format="html") %>% 
  kableExtra::kable_styling(bootstrap_options = "basic")
```

Table columns can be sorted and filtered. Dataset names are linked to documentation if available. Datasets without links are usually included in documentation for a dataset in the same package with a similar name. For example, documentation for `alr4::BGSboys` and `alr4::BGSgirls` is included on the help page for `alr4::BGSall`.


## Exploring data in packages locally

The main function used here is `data_xray()` from the **datacat** package. You can explore datasets in R packages locally as follows.

Install **datacat**:

```{r, eval = FALSE, echo = TRUE}
remotes::install_github("jtr13/datacat")
```

View information with:

```{r, eval = FALSE, echo = TRUE}
library(datacat)
data_xray("ggplot2") %>% View()
```

## Contributing

I welcome your suggestions on packages to add to this resource. You can either [open an issue]() or add the package name to [this file]() and create a pull request.

I have intentionally left out packages with nondescriptive dataset names such as `ch5ex11`: **[AMCP]()**, **[Devore7]**

If you think this is a mistake, I'm open to discussion on the topic.
